<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Producci√≥n Alkimyk</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #1e1e1e;
            margin: 40px;
        }
        .logo {
            position: absolute;
            top: 20px;
            right: 40px;
            width: 150px;
        }
        .menu-principal {
            position: absolute;
            top: 20px;
            left: 40px;
            background-color: #2196F3;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
        }
        h1, h2, h3 {
            color: #1e1e1e;
            text-align: center;
        }
        form div {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        label {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        input[type=number] {
            width: 100px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #aaa;
        }
        button {
            padding: 12px 24px;
            margin-right: 10px;
            border: none;
            border-radius: 6px;
            background-color: #4caf50;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            background-color: #45a049;
        }
        .limpiar {
            background-color: #f44336;
        }
        .limpiar:hover {
            background-color: #da190b;
        }
        table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px 12px;
            text-align: left;
        }
        th {
            background-color: #ddd;
            color: #000;
        }
        td {
            background-color: #fff;
        }
        #totalizado {
            display: none;
            margin-top: 30px;
        }
        .separador {
            border-top: 2px solid #888;
            margin-top: 30px;
            padding-top: 20px;
        }
        .mostrar { display: block; }
        .ocultar { display: none; }
        .recuadro {
            max-width: 800px;
            margin: 30px auto;
            background-color: #ffffff;
            color: #000;
            border: 1px solid #000;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: justify;
        }
        .titulo-sabor {
            background-color: #cfe8fc;
            padding: 8px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .spinner-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #4caf50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .spinner-text {
            margin-top: 10px;
            font-size: 1em;
            color: #333;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .footer {
            text-align: center;
            margin-top: 50px;
            font-size: 0.9em;
            color: #444;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                z-index: 9999;
                background: white;
                padding: 20px;
                font-family: 'Roboto', sans-serif;
            }
            .no-print {
                display: none !important;
            }
            button {
                display: none !important;
            }
            table {
                border-collapse: collapse;
                width: 100%;
            }
            table, th, td {
                border: 0.5px solid #aaa;
            }
            th {
                background-color: #eee;
            }
            td, th {
                padding: 6px 8px;
                font-size: 14px;
            }
        }
        .btn-print {
            padding: 4px 10px;
            font-size: 0.85em;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-print:hover {
            background-color: #1976D2;
        }
    </style>
    <script>
        function mostrarTotalizado() {
            document.getElementById('bloque-totalizado').style.display = 'block';
            document.getElementById('boton-total').style.display = 'none';
        }
        function limpiarFormulario() {
            document.getElementById('aceituna').value = '0';
            document.getElementById('caprese').value = '0';
            document.getElementById('queso_azul').value = '0';
            document.getElementById('cebolla').value = '0';
            document.getElementById('espinaca').value = '0';
            document.getElementById('calabaza').value = '0';
            document.getElementById('brocoli').value = '0';
            // El cupo diario NO se borra
            const bloques = ['bloque-por-sabor', 'bloque-totalizado', 'bloque-calendario'];
            bloques.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const calendarDivs = Array.from(document.querySelectorAll('.recuadro'));
            calendarDivs.forEach(div => {
                if (div.querySelector('h2') && div.querySelector('h2').textContent.includes('Definir calendario de producci√≥n')) {
                    div.style.display = 'none';
                }
            });
            document.getElementById('boton-total').style.display = 'block';
            return false;
        }
        function copiarCanastos() {
            document.getElementById('excel_aceituna').value = document.querySelector('input[name="aceituna"]').value;
            document.getElementById('excel_caprese').value = document.querySelector('input[name="caprese"]').value;
            document.getElementById('excel_queso_azul').value = document.querySelector('input[name="queso_azul"]').value;
            document.getElementById('excel_cebolla').value = document.querySelector('input[name="cebolla"]').value;
            document.getElementById('excel_espinaca').value = document.querySelector('input[name="espinaca"]').value;
            document.getElementById('excel_calabaza').value = document.querySelector('input[name="calabaza"]').value;
            document.getElementById('excel_brocoli').value = document.querySelector('input[name="brocoli"]').value;
            return true;
        }
        function mostrarCarga() {
            const spinner = document.getElementById('spinner-container');
            spinner.style.display = 'flex';
            setTimeout(() => {
                document.querySelector('form').submit();
            }, 3000);
            return false;
        }
        function imprimirBloque(id) {
            const bloque = document.getElementById(id);
            if (!bloque) return;

            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Impresi√≥n</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>body{font-family:"Roboto",sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:0.5px solid #aaa;padding:6px 8px;font-size:14px;} th{background-color:#eee;} .titulo-sabor{margin-top:20px;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<img src="/static/logo.png" style="width:150px;float:right;">');
            printWindow.document.write(bloque.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            setTimeout(() => { printWindow.close(); }, 1000);
        }
    </script>
    <script>
        function validarFormulario() {
            const inputs = document.querySelectorAll('input[type=number]');
            for (let input of inputs) {
                if (input.value === '' || isNaN(input.value)) {
                    alert('Por favor complet√° todos los campos con un n√∫mero v√°lido.');
                    return false;
                }
            }
            return mostrarCarga();
        }
    </script>
</head>
<body>
    <img src="/static/logo.png" class="logo" alt="Logo Alkimyk">
    <a href="/" class="menu-principal">üè† Men√∫ Principal</a>

    <h1 style="margin-bottom: 30px;">¬øQu√© tenemos que producir?</h1>
    <form method="post" action="/canastos" onsubmit="return validarFormulario();" style="max-width: 600px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); color: #000; border: 1px solid #000; text-align: justify;">
        <div><label>Canastos Aceituna: <input type="number" id="aceituna" name="aceituna" value="{{ canastos.get('aceituna', 0) }}" required></label></div>
        <div><label>Canastos Caprese: <input type="number" id="caprese" name="caprese" value="{{ canastos.get('caprese', 0) }}" required></label></div>
        <div><label>Canastos Queso Azul: <input type="number" id="queso_azul" name="queso_azul" value="{{ canastos.get('queso_azul', 0) }}" required></label></div>
        <div><label>Canastos Cebolla: <input type="number" id="cebolla" name="cebolla" value="{{ canastos.get('cebolla', 0) }}" required></label></div>
        <div><label>Canastos Espinaca: <input type="number" id="espinaca" name="espinaca" value="{{ canastos.get('espinaca', 0) }}" required></label></div>
        <div><label>Canastos Calabaza: <input type="number" id="calabaza" name="calabaza" value="{{ canastos.get('calabaza', 0) }}" required></label></div>
        <div><label>Canastos Br√≥coli: <input type="number" id="brocoli" name="brocoli" value="{{ canastos.get('brocoli', 0) }}" required></label></div>
        <div><label>L√≠mite diario de producci√≥n (canastos): <input type="number" id="cupo_diario" name="cupo_diario" value="{{ session.get('cupo_diario', 120) }}" required></label></div>
        <button type="submit">‚úÖ Calcular</button>
        <button type="button" class="limpiar" onclick="limpiarFormulario()">‚ùå Limpiar todo</button>
        <input type="hidden" name="incluir_sabado" value="{{ session.get('incluir_sabado', False)|int }}">
        <input type="hidden" name="incluir_domingo" value="{{ session.get('incluir_domingo', False)|int }}">
    </form>
    <div id="spinner-container" class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Calculando...</div>
    </div>

    {% if mostrar %}
    <div class="recuadro" style="margin-top: 20px;">
        <h2>Definir calendario de producci√≥n</h2>
        <form method="post" action="/calendario">
            {% if session.get('dias_habilitados') %}
                <p><strong>D√≠as seleccionados para producci√≥n:</strong> {{ session.get('dias_habilitados') | join(', ') | title }}</p>
            {% endif %}
            <label for="fecha_inicio">Fecha de inicio de producci√≥n:</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" required>
            <p style="margin-top: 10px;">
              Cantidad total: {{ canastos.values() | sum }} canastos ‚Äì
              Se necesitan {{
                ((canastos.values() | sum - 1) // session.get('cupo_diario', 120) + 1)
              }} d√≠as de producci√≥n.
            </p>
            {% for dia in ['lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado', 'domingo'] %}
                {% if session.get('dias_habilitados') and dia in session.get('dias_habilitados') %}
                    <input type="hidden" name="dias_habilitados" value="{{ dia }}">
                {% endif %}
            {% endfor %}
            <button type="submit" class="btn-print">üìÖ Generar Calendario</button>
        </form>
    </div>
    {% endif %}



    {% if mostrar %}
    <div id="bloque-por-sabor" class="recuadro printable">
        <h2>Ingredientes por sabor</h2>
        <button class="no-print btn-print" onclick="imprimirBloque('bloque-por-sabor')">üñ®Ô∏è Imprimir</button>
        {% for sabor, ingredientes_sabor in detalles_por_sabor.items() %}
            {% if canastos[sabor] > 0 %}
                {% set cajas = (canastos[sabor] * 18) // 60 %}
                <div class="titulo-sabor">
                    <h3>{{ sabor.replace('_', ' ').capitalize() }} ({{ canastos[sabor] }} Canastos - {{ cajas }} Cajas)</h3>
                </div>
                <table>
                    <tr><th>Ingrediente</th><th>Cantidad</th></tr>
                    {% for ingr, cant in ingredientes_sabor.items() %}
                        <tr>
                            <td>{{ ingr }}</td>
                            <td>
                                {% if cant >= 1000 %}
                                    {{ (cant / 1000) | round(2) }} kg
                                {% else %}
                                    {{ cant | round(2) }} g
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {% if mostrar %}
    <div class="separador">
        <button id="boton-total" onclick="mostrarTotalizado(); return false;">üìã Mostrar totalizado de compras</button>

        <div id="bloque-totalizado" class="recuadro printable" style="display: none;">
            {% set total_cajas = ((canastos.values() | sum) * 18) // 60 %}
            <h2>Total de ingredientes para comprar y elaborar {{ canastos.values() | sum }} canastos ({{ total_cajas }} Cajas)</h2>
            <table>
                <tr><th>Ingrediente</th><th>Cantidad</th><th>Unidad</th></tr>
                {% for ingrediente, cantidad in ingredientes.items() %}
                    <tr>
                        <td>{{ ingrediente }}</td>
                        <td>
                            {% if ingrediente == 'Soja' or ingrediente == 'Harina' %}
                                {{ (cantidad / 1) | round(2) }}
                            {% elif cantidad >= 1000 %}
                                {{ (cantidad / 1000) | round(2) }}
                            {% else %}
                                {{ cantidad | round(2) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if ingrediente == 'Soja' or ingrediente == 'Harina' %}
                                kg
                            {% elif cantidad >= 1000 %}
                                kg
                            {% else %}
                                g
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>

            <form method="post" action="/exportar" onsubmit="return copiarCanastos()">
                <input type="hidden" name="aceituna" id="excel_aceituna">
                <input type="hidden" name="caprese" id="excel_caprese">
                <input type="hidden" name="queso_azul" id="excel_queso_azul">
                <input type="hidden" name="cebolla" id="excel_cebolla">
                <input type="hidden" name="espinaca" id="excel_espinaca">
                <input type="hidden" name="calabaza" id="excel_calabaza">
                <input type="hidden" name="brocoli" id="excel_brocoli">
                <button type="submit">‚¨áÔ∏è Exportar a Excel</button>
                {% if session.get('rol') == 'admin' %}
                    <a href="{{ url_for('costos') }}" class="btn-print" style="margin-left: 10px;">üí≤ Ver Costos</a>
                {% endif %}
            </form>
            <button class="no-print btn-print" onclick="imprimirBloque('bloque-totalizado')">üñ®Ô∏è Imprimir</button>
        </div>
    </div>
    {% endif %}
</body>
</html>
