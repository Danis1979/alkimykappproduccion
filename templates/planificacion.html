<div class="container">
    <!-- Panel de planificaciÃ³n mensual -->
    <div class="panel">
        <div class="titulo-panel">ðŸ“¦ PlanificaciÃ³n Mensual</div>
        {% if planificacion %}
            {% for sabor, datos in planificacion.items() %}
                <div class="linea-dato">
                    <span><strong>{{ sabor | capitalize }}</strong></span>
                    <span>Canastos: {{ datos['canastos'] }}</span>
                    <span>Cajas: {{ datos['cajas'] }}</span>
                </div>
            {% endfor %}
        {% else %}
            <p>No hay datos de planificaciÃ³n disponibles.</p>
        {% endif %}
    </div>

    <!-- Panel de compras -->
    <div class="panel">
        <div class="titulo-panel">ðŸ›’ Ingredientes para Comprar</div>
        {% for ingrediente, cantidad in total_ingredientes_fmt.items() %}
            <div class="linea-dato">
                <span><strong>{{ ingrediente | capitalize }}</strong>: {{ cantidad.cantidad }} {{ cantidad.unidad }}</span>
                <button class="boton-comprar" onclick="abrirPopupCompra('{{ ingrediente }}', '{{ cantidad.cantidad }} {{ cantidad.unidad }}')">Comprar</button>
            </div>
        {% endfor %}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function abrirPopupCompra(ingrediente, cantidad) {
    Swal.fire({
      title: 'ðŸ›’ Comprar ' + ingrediente,
      html:
        '<p><strong>Cantidad necesaria:</strong> ' + cantidad + '</p>' +
        '<select id="proveedor_existente" class="swal2-input">' +
          '<option value="">Seleccionar proveedor</option>' +
          '{% for proveedor in proveedores %}' +
            '<option value="{{ proveedor }}">{{ proveedor }}</option>' +
          '{% endfor %}' +
        '</select>' +
        '<input id="proveedor_nuevo" class="swal2-input" placeholder="Agregar nuevo proveedor (opcional)">' +
        '<select id="forma_pago" class="swal2-input">' +
          '<option value="">Forma de pago</option>' +
          '<option value="Efectivo">Efectivo</option>' +
          '<option value="Transferencia">Transferencia</option>' +
          '<option value="Cheque">Cheque</option>' +
        '</select>' +
        '<input id="fecha_pago" type="date" class="swal2-input" placeholder="Fecha de pago">',
      confirmButtonText: 'Guardar compra',
      focusConfirm: false,
      preConfirm: () => {
        const proveedorExistente = document.getElementById('proveedor_existente').value;
        const proveedorNuevo = document.getElementById('proveedor_nuevo').value;
        const proveedor = proveedorNuevo || proveedorExistente;
        const forma_pago = document.getElementById('forma_pago').value;
        const fecha_pago = document.getElementById('fecha_pago').value;
        if (!proveedor || !forma_pago || !fecha_pago) {
          Swal.showValidationMessage('Todos los campos son obligatorios');
          return false;
        }
        return { proveedor, forma_pago, fecha_pago, ingrediente, cantidad };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/registrar_compra', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(result.value)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Guardado', 'La compra fue registrada.', 'success').then(() => {
              location.reload();
            });
          } else {
            Swal.fire('Error', 'Hubo un problema al guardar.', 'error');
          }
        });
      }
    });
  }
</script>