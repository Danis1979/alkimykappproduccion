<div class="container">
    <!-- Panel de planificaciÃ³n mensual -->
    <div class="panel">
        <div class="titulo-panel">ðŸ“¦ PlanificaciÃ³n Mensual</div>
        {% if planificacion %}
            {% for sabor, datos in planificacion.items() %}
                <div class="linea-dato">
                    <span><strong>{{ sabor | capitalize }}</strong></span>
                    <span>Canastos: {{ datos['canastos'] }}</span>
                    <span>Cajas: {{ datos['cajas'] }}</span>
                </div>
            {% endfor %}
        {% else %}
            <p>No hay datos de planificaciÃ³n disponibles.</p>
        {% endif %}
    </div>

    <!-- Panel de compras -->
    <div class="panel">
        <div class="titulo-panel">ðŸ›’ Ingredientes para Comprar</div>
        {% for ingrediente, cantidad in total_ingredientes_fmt.items() %}
            <div class="linea-dato">
                <span><strong>{{ ingrediente | capitalize }}</strong>: {{ cantidad.cantidad - compras.get(ingrediente, 0) }} {{ cantidad.unidad }}</span>
                <button class="boton-comprar" onclick="abrirPopupCompra('{{ ingrediente }}', '{{ cantidad.cantidad }} {{ cantidad.unidad }}')">Comprar</button>
            </div>
        {% endfor %}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function abrirPopupCompra(ingrediente, cantidad) {
    Swal.fire({
      title: 'ðŸ›’ Comprar ' + ingrediente,
      html:
        '<div style="display:flex; flex-direction:column; align-items:center;">' +
          '<p style="font-size: 16px; font-weight: bold;"><strong>Necesario:</strong> ' + cantidad + '</p>' +
          '<input id="cantidad_comprar" class="swal2-input" placeholder="Cantidad a comprar" style="width: 300px;">' +
          '<select id="proveedor_existente" class="swal2-input" style="width: 300px;">' +
            '<option value="">Seleccionar proveedor</option>' +
            '{% for proveedor in proveedores %}' +
              '<option value="{{ proveedor }}">{{ proveedor }}</option>' +
            '{% endfor %}' +
          '</select>' +
          '<button id="abrir_popup_nuevo_proveedor" class="swal2-confirm swal2-styled" style="margin: 5px auto 10px auto; background-color: #3085d6;">Agregar nuevo proveedor</button>' +
          '<select id="forma_pago" class="swal2-input" style="width: 300px;">' +
            '<option value="">Forma de pago</option>' +
            '<option value="Efectivo">Efectivo</option>' +
            '<option value="Transferencia">Transferencia</option>' +
            '<option value="Cheque">Cheque</option>' +
          '</select>' +
          '<label for="fecha_pago" style="margin-top:10px; font-weight:bold;">Fecha de pago</label>' +
          '<input id="fecha_pago" type="date" class="swal2-input" style="width: 300px;">' +
        '</div>',
      didOpen: () => {
        document.getElementById('abrir_popup_nuevo_proveedor').onclick = function () {
          Swal.fire({
            title: 'Agregar nuevo proveedor',
            input: 'text',
            inputLabel: 'Nombre del proveedor',
            inputPlaceholder: 'IngresÃ¡ el nombre',
            showCancelButton: true,
            confirmButtonText: 'Agregar',
            preConfirm: (nuevoProveedor) => {
              if (!nuevoProveedor || nuevoProveedor.trim() === "") {
                Swal.showValidationMessage('El nombre del proveedor es obligatorio');
                return false;
              }
              return fetch('/agregar_proveedor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ 'nombre': nuevoProveedor.trim() })
              })
              .then(resp => {
                if (!resp.ok) {
                  throw new Error('Error de red');
                }
                return resp.json();
              })
              .then(data => {
                if (data.success) {
                  Swal.fire('Proveedor agregado', 'Ya podÃ©s seleccionarlo.', 'success').then(() => location.reload());
                } else {
                  Swal.fire('Error', data.message || 'No se pudo agregar el proveedor.', 'error');
                }
              })
              .catch(err => {
                Swal.fire('Error', 'No se pudo agregar el proveedor.', 'error');
              });
            }
          });
        };
      },
      confirmButtonText: 'Guardar compra',
      focusConfirm: false,
      preConfirm: () => {
        const cantidad_comprar = document.getElementById('cantidad_comprar').value;
        const proveedorExistente = document.getElementById('proveedor_existente').value;
        const proveedor = proveedorExistente;
        const forma_pago = document.getElementById('forma_pago').value;
        const fecha_pago = document.getElementById('fecha_pago').value;
        const cantidad_comprar_valor = parseFloat(cantidad_comprar);
        if (!cantidad_comprar || isNaN(cantidad_comprar_valor) || cantidad_comprar_valor <= 0) {
          Swal.showValidationMessage('La cantidad debe ser un nÃºmero vÃ¡lido mayor a 0');
          return false;
        }
        if (!proveedor || proveedor.trim() === '') {
          Swal.showValidationMessage('Debe seleccionar un proveedor');
          return false;
        }
        if (!forma_pago || forma_pago.trim() === '') {
          Swal.showValidationMessage('Debe seleccionar una forma de pago');
          return false;
        }
        if (!fecha_pago || fecha_pago.trim() === '') {
          Swal.showValidationMessage('Debe ingresar una fecha de pago');
          return false;
        }
        return {
          ingrediente,
          cantidad_total: cantidad,
          cantidad_comprar: cantidad_comprar_valor,
          proveedor: proveedor.trim(),
          forma_pago: forma_pago.trim(),
          fecha_pago: fecha_pago.trim()
        };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/registrar_compra', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(result.value)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'âœ… Compra ingresada con Ã©xito',
              showConfirmButton: false,
              timer: 1500
            }).then(() => {
              // Actualizar la cantidad restante directamente
              const boton = document.querySelector(`button[onclick*="${ingrediente}"]`);
              if (boton) {
                const span = boton.previousElementSibling;
                const texto = span.innerText;
                const partes = texto.split(':');
                const cantidadActualTexto = partes[1].trim().split(' ')[0];
                const unidad = partes[1].trim().split(' ')[1];
                const cantidadActual = parseFloat(cantidadActualTexto);
                const nuevaCantidad = cantidadActual - result.value.cantidad_comprar;
                span.innerText = `${ingrediente.charAt(0).toUpperCase() + ingrediente.slice(1)}: ${nuevaCantidad.toFixed(2)} ${unidad}`;
              }
            });
          } else {
            Swal.fire('Error', data.message || 'Hubo un problema al guardar.', 'error');
          }
        });
      }
    });
  }
</script>